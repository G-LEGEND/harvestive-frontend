<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deposit</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #333;
      margin: 0;
      padding: 0;
    }

    .deposit-container {
      max-width: 400px;
      margin: 50px auto;
      padding: 25px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 2px solid #d4af37; /* gold border */
    }

    h2 {
      text-align: center;
      color: #d4af37;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #555;
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
    }

    input:focus, select:focus {
      border-color: #d4af37;
      outline: none;
    }

    .note {
      font-size: 13px;
      color: #b59428;
      margin-top: 4px;
    }

    .note.error {
      color: #e74c3c;
    }

    button {
      background: #d4af37;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }

    button:hover {
      background: #b59428;
    }

    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      border: 2px solid #d4af37;
    }

    .modal button {
      width: auto;
      margin: 10px;
    }

    .qr-img {
      max-width: 140px;
      margin: 10px auto;
      display: block;
      border: 2px solid #d4af37;
      border-radius: 8px;
    }

    .wallet-box {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9f9f9;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }

    .wallet-text {
      word-break: break-all;
      font-size: 14px;
      color: #333;
      flex: 1;
      margin-right: 10px;
    }

    .copy-btn {
      background: #d4af37;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: 0.3s;
      white-space: nowrap;
    }

    .copy-btn:hover {
      background: #b59428;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      background: #fff;
      border-top: 2px solid #d4af37;
      padding: 10px 0;
    }

    .bottom-nav a {
      text-align: center;
      text-decoration: none;
      color: #333;
      font-size: 14px;
    }

    .bottom-nav a.active {
      color: #d4af37;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .error-message {
      background: #fee;
      color: #c00;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 14px;
      display: none;
    }

    .method-info {
      margin: 15px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    
    .debug-info {
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="deposit-container">
    <h2>Deposit</h2>

    <div id="errorMessage" class="error-message"></div>
    
    <!-- Debug info (hidden by default) -->
    <div id="debugInfo" class="debug-info"></div>

    <form id="depositForm">
      <label>Amount (USD)</label>
      <input type="number" id="depositAmount" required placeholder="Enter amount" min="100" step="any">
      <div class="note">Minimum deposit is 100 USD</div>

      <label>Select Method</label>
      <select id="depositMethod" required onchange="updateMethodDetails()">
        <option value="">Select a payment method</option>
      </select>
      <div id="methodLoading" class="loading" style="display: none;">Loading methods...</div>

      <div id="methodDetails" style="margin:15px 0; display:none;">
        <div class="method-info">
          <p><b>Payment Instructions:</b></p>
          <p style="font-size: 13px; color: #666; margin: 5px 0;">
            1. Send the exact amount to the address below<br>
            2. Take a screenshot of the transaction<br>
            3. Upload the screenshot as proof
          </p>
        </div>
        
        <p><b>Wallet Address:</b></p>
        <div class="wallet-box">
          <span id="walletAddress" class="wallet-text"></span>
          <button type="button" class="copy-btn" onclick="copyAddress()">Copy</button>
        </div>
        
        <div id="qrContainer">
          <p><b>QR Code:</b></p>
          <img id="walletQR" class="qr-img" alt="QR Code" onerror="this.style.display='none'">
          <div id="qrError" style="color: #e74c3c; font-size: 12px; display: none;">QR code not available</div>
        </div>
      </div>

      <label>Upload Payment Proof (Screenshot)</label>
      <input type="file" id="screenshot" accept="image/*,.png,.jpg,.jpeg,.webp" required>
      <div class="note">Upload a clear screenshot of your payment transaction</div>

      <button type="button" id="submitBtn" onclick="openConfirmModal()">I Have Paid</button>
    </form>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>Confirm Payment</h3>
      <p>Are you sure you have sent the payment?</p>
      <p style="font-size: 14px; color: #666; margin: 10px 0;">
        Please ensure you have:<br>
        1. Sent the exact amount<br>
        2. Taken a screenshot<br>
        3. Double-checked the wallet address
      </p>
      <div>
        <button onclick="submitDeposit()" id="confirmYesBtn">Yes, I Have Paid</button>
        <button onclick="closeConfirmModal()" style="background: #ccc; color: #333;">No, Cancel</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="deposit.html" class="active"><i class="fas fa-wallet"></i><br>Deposit</a>
    <a href="invest.html"><i class="fas fa-piggy-bank"></i><br>Invest</a>
    <a href="dashboard.html"><i class="fas fa-home"></i><br>Home</a>
    <a href="withdraw.html"><i class="fas fa-money-bill"></i><br>Withdraw</a>
    <a href="transfer.html"><i class="fas fa-exchange-alt"></i><br>Transfer</a>
  </div>

  <script>
    const API_BASE = 'https://harvestive-co-backend.onrender.com';
    let depositMethods = [];
    let isSubmitting = false;

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }
    
    function showDebugInfo(info) {
      const debugDiv = document.getElementById('debugInfo');
      debugDiv.innerHTML = '<strong>Debug Info:</strong><br>' + info;
      debugDiv.style.display = 'block';
    }

    async function loadDepositMethods() {
      const select = document.getElementById('depositMethod');
      const loading = document.getElementById('methodLoading');
      
      select.disabled = true;
      loading.style.display = 'block';
      
      try {
        console.log('Fetching deposit methods from:', `${API_BASE}/user/deposit-methods`);
        const res = await fetch(`${API_BASE}/user/deposit-methods`);
        
        console.log('Response status:', res.status, res.statusText);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('Response error text:', errorText);
          throw new Error(`Failed to load methods: ${res.status} ${res.statusText}\n${errorText}`);
        }
        
        const methods = await res.json();
        console.log('Received methods:', methods);
        
        // Show debug info
        let debugInfo = `Found ${methods?.length || 0} methods<br>`;
        if (methods && methods.length > 0) {
          debugInfo += `First method: ${methods[0].name}<br>`;
          debugInfo += `First method _id: ${methods[0]._id}<br>`;
          debugInfo += `First method _id type: ${typeof methods[0]._id}<br>`;
          if (methods[0]._id && typeof methods[0]._id === 'object') {
            debugInfo += `First method _id keys: ${Object.keys(methods[0]._id).join(', ')}<br>`;
            debugInfo += `First method _id string: ${methods[0]._id.toString ? methods[0]._id.toString() : 'No toString method'}`;
          }
        }
        showDebugInfo(debugInfo);
        
        // Process methods to ensure _id is a string
        depositMethods = methods.map(method => {
          let id = method._id;
          
          // Handle different _id formats
          if (id && typeof id === 'object') {
            // If it's an ObjectId object from MongoDB
            if (id.$oid) {
              id = id.$oid; // MongoDB extended JSON format
            } else if (id.toString) {
              id = id.toString(); // MongoDB ObjectId
            } else {
              id = JSON.stringify(id); // Fallback
            }
          }
          
          return {
            ...method,
            _id: id
          };
        });
        
        console.log('Processed methods:', depositMethods);

        select.innerHTML = '<option value="">Select a payment method</option>';
        
        if (!depositMethods || depositMethods.length === 0) {
          select.innerHTML += '<option value="" disabled>No payment methods available</option>';
          showError('No deposit methods available. Please contact support.');
          return;
        }

        depositMethods.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m._id;
          opt.textContent = m.name;
          select.appendChild(opt);
        });

        select.disabled = false;
        
        // Auto-select first method if available
        if (depositMethods.length > 0) {
          select.value = depositMethods[0]._id;
          console.log('Auto-selected method ID:', depositMethods[0]._id);
          updateMethodDetails();
        }
        
      } catch (err) {
        console.error('Error loading deposit methods:', err);
        console.error('Error stack:', err.stack);
        select.innerHTML = '<option value="" disabled>Error loading methods</option>';
        showError('Error loading payment methods: ' + err.message);
      } finally {
        loading.style.display = 'none';
      }
    }

    function updateMethodDetails() {
      const id = document.getElementById('depositMethod').value;
      console.log('Selected ID:', id);
      console.log('Available methods:', depositMethods);
      
      // Find method using string comparison
      const method = depositMethods.find(m => {
        console.log(`Comparing: selected="${id}" with method._id="${m._id}" (type: ${typeof m._id})`);
        return String(m._id) === String(id);
      });
      
      console.log('Found method:', method);
      
      const detailsDiv = document.getElementById('methodDetails');
      const qrImg = document.getElementById('walletQR');
      const qrError = document.getElementById('qrError');

      if (method) {
        document.getElementById('walletAddress').innerText = method.address || 'Address not available';
        
        // Handle QR code
        if (method.qr) {
          qrImg.src = method.qr;
          qrImg.style.display = 'block';
          qrError.style.display = 'none';
        } else {
          qrImg.style.display = 'none';
          qrError.style.display = 'block';
        }
        
        detailsDiv.style.display = 'block';
      } else {
        detailsDiv.style.display = 'none';
        console.warn('No method found for ID:', id);
      }
    }

    function copyAddress() {
      const address = document.getElementById('walletAddress').innerText;
      if (!address || address === 'Address not available') {
        showError('No address to copy');
        return;
      }
      
      navigator.clipboard.writeText(address).then(() => {
        alert('✅ Wallet address copied to clipboard!');
      }).catch(err => {
        console.error('Copy failed:', err);
        showError('Failed to copy address');
      });
    }

    function openConfirmModal() {
      const amount = parseFloat(document.getElementById('depositAmount').value);
      const methodId = document.getElementById('depositMethod').value;
      const screenshot = document.getElementById('screenshot').files[0];

      console.log('Opening confirm modal with:', { amount, methodId, screenshot });

      // Validation
      if (!amount || isNaN(amount)) {
        showError('Please enter a valid amount');
        return;
      }
      
      if (amount < 100) {
        showError('Minimum deposit is 100 USD');
        return;
      }
      
      if (!methodId) {
        showError('Please select a payment method');
        return;
      }
      
      if (!screenshot) {
        showError('Please upload payment proof screenshot');
        return;
      }

      // Check file size (max 5MB)
      if (screenshot.size > 5 * 1024 * 1024) {
        showError('File too large. Maximum size is 5MB');
        return;
      }

      // Check file type
      const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];
      if (!validTypes.includes(screenshot.type)) {
        showError('Please upload a valid image (JPEG, PNG, or WebP)');
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        showError('You must be logged in');
        setTimeout(() => window.location.href = 'index.html', 1000);
        return;
      }

      document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    async function submitDeposit() {
      if (isSubmitting) return;
      
      const amount = parseFloat(document.getElementById('depositAmount').value);
      const methodId = document.getElementById('depositMethod').value;
      const screenshot = document.getElementById('screenshot').files[0];
      const token = localStorage.getItem('token');
      
      console.log('Submitting deposit:', { amount, methodId, hasScreenshot: !!screenshot, hasToken: !!token });
      
      if (!token) {
        showError('Session expired. Please login again.');
        setTimeout(() => window.location.href = 'index.html', 1000);
        return;
      }

      isSubmitting = true;
      const submitBtn = document.getElementById('submitBtn');
      const confirmYesBtn = document.getElementById('confirmYesBtn');
      const originalSubmitText = submitBtn.textContent;
      const originalConfirmText = confirmYesBtn.textContent;
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';
      confirmYesBtn.disabled = true;
      confirmYesBtn.textContent = 'Processing...';

      const formData = new FormData();
      formData.append('amount', amount);
      formData.append('method', methodId);
      formData.append('screenshot', screenshot);

      try {
        console.log('Sending deposit request to:', `${API_BASE}/deposit`);
        const res = await fetch(`${API_BASE}/deposit`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        console.log('Deposit response status:', res.status);
        const data = await res.json();
        console.log('Deposit response data:', data);
        
        if (res.ok) {
          alert(`✅ ${data.message || 'Deposit submitted successfully!'}\n\nStatus: Pending approval\nAmount: $${amount}\n\nPlease wait for admin approval.`);
          closeConfirmModal();
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 1000);
        } else {
          throw new Error(data.error || `Deposit failed: ${res.status}`);
        }
        
      } catch (err) {
        console.error('Deposit error:', err);
        showError(err.message || 'Error submitting deposit. Please try again.');
        closeConfirmModal();
      } finally {
        isSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.textContent = originalSubmitText;
        confirmYesBtn.disabled = false;
        confirmYesBtn.textContent = originalConfirmText;
      }
    }

    // Load methods on page load
    window.onload = function() {
      console.log('Page loaded, loading deposit methods...');
      loadDepositMethods();
    };

    // Close modal when clicking outside
    document.getElementById('confirmModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeConfirmModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeConfirmModal();
      }
    });

    // Validate amount input
    document.getElementById('depositAmount').addEventListener('input', function() {
      const amount = parseFloat(this.value);
      if (amount < 100) {
        this.style.borderColor = '#e74c3c';
      } else {
        this.style.borderColor = '#d4af37';
      }
    });
  </script>
</body>
</html>